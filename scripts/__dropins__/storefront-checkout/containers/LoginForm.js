/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as m,Fragment as B}from"@dropins/tools/preact-jsx-runtime.js";import{s as M}from"../chunks/state.js";import{b as t,c as T,f as $}from"../chunks/transform-store-config.js";import"@dropins/tools/event-bus.js";import{classes as w}from"@dropins/tools/lib.js";import{i as I,s as V}from"../chunks/setGuestEmailOnCart.js";import{Field as H,Input as P,Skeleton as R,SkeletonRow as b}from"@dropins/tools/components.js";/* empty css                             */import"../chunks/TermsAndConditions.js";import{useText as N,Text as L}from"@dropins/tools/i18n.js";/* empty css                      *//* empty css                  *//* empty css                       */import{w as j}from"../chunks/withConditionalRendering.js";import{useRef as q,useEffect as x}from"@dropins/tools/preact-hooks.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/store-config.js";import"@dropins/tools/signals.js";import"../chunks/errors.js";import"../chunks/synchronizeCheckout.js";import"../fragments.js";const D={EMAIL:/^[a-z0-9,!#$%&'*+/=?^_`{|}~-]+(\.[a-z0-9,!#$%&'*+/=?^_`{|}~-]+)*@([a-z0-9-]+\.)+[a-z]{2,}$/i},k=o=>D.EMAIL.test(o),W=({value:o,error:n,hint:d,onChange:g,onBlur:u,onInvalid:r})=>{const i=N({LoginFormLabel:"Checkout.LoginForm.ariaLabel",LoginFormFloatingLabel:"Checkout.LoginForm.floatingLabel",LoginFormPlaceholder:"Checkout.LoginForm.placeholder"});return e(H,{error:n,hint:d,children:e(P,{"aria-label":i.LoginFormLabel,"aria-required":!0,autocomplete:"email",floatingLabel:i.LoginFormFloatingLabel,id:"customer-email",name:"customer-email",onBlur:u,onChange:g,onInvalid:r,placeholder:i.LoginFormPlaceholder,required:!0,type:"email",value:o})})},G=({onClick:o})=>m("div",{className:"checkout-login-form__sign-in",children:[e(L,{id:"Checkout.LoginForm.account"}),e("a",{"data-testid":"sign-in-link",className:"checkout-login-form__link",href:"#",target:"_blank",rel:"noreferrer",onClick:o,children:e(L,{id:"Checkout.LoginForm.signIn"})})]}),U=({className:o,customerDetails:n,email:d,error:g,hint:u,loading:r=!1,name:i,onEmailBlur:F,onEmailChange:c,onEmailInvalid:s,onSignInClick:h,onSignOutClick:v,...p})=>{const _=N({Title:"Checkout.LoginForm.title"});return r?e(J,{}):m("div",{className:"checkout-login-form","data-testid":"checkout-login-form",children:[m("div",{className:"checkout-login-form__heading",children:[e("h2",{className:"checkout-login-form__title",children:_.Title}),n?e(K,{onClick:f=>{f.preventDefault(),v==null||v()}}):e(G,{onClick:f=>{f.preventDefault(),h==null||h(d)}})]}),n?m("div",{className:"checkout-login-form__customer-details",children:[e("div",{className:"checkout-login-form__customer-name",children:`${n.firstName} ${n.lastName}`}),e("div",{className:"checkout-login-form__customer-email",children:n.email})]}):e("div",{className:"checkout-login-form__content",children:m("form",{...p,className:w(["dropin-login-form__form",o]),name:i,noValidate:!0,children:[e("button",{type:"submit",disabled:!0,style:"display: none","aria-hidden":"true"}),e(W,{value:d,error:g,hint:u,onChange:c,onBlur:F,onInvalid:s})]})})]})},J=()=>m(R,{"data-testid":"login-form-skeleton",children:[e(b,{variant:"heading",fullWidth:!0}),e(b,{size:"medium",fullWidth:!0})]}),K=({onClick:o})=>m("p",{className:"checkout-login-form__sign-out",children:[e(L,{id:"Checkout.LoginForm.switch"}),e("a",{className:"checkout-login-form__link",href:"#",target:"_blank",rel:"noreferrer",onClick:o,children:e(L,{id:"Checkout.LoginForm.signOut"})})]}),O=1e3,C=({onSignInClick:o,onSignOutClick:n,initialData:d,...g})=>{const u=q(""),r=t.value,i=T.value.data,F=(i==null?void 0:i.email)||"",c=$.value.data,s=N({LoginFormInvalidEmailError:"Checkout.LoginForm.invalidEmailError",LoginFormMissingEmailError:"Checkout.LoginForm.missingEmailError",LoginFormEmailExistsAlreadyHaveAccount:"Checkout.LoginForm.emailExists.alreadyHaveAccount",LoginFormEmailExistsSignInButton:"Checkout.LoginForm.emailExists.signInButton",LoginFormEmailExistsForFasterCheckout:"Checkout.LoginForm.emailExists.forFasterCheckout"}),h=a=>a.valid?"":a.valueMissing?s.LoginFormMissingEmailError:s.LoginFormInvalidEmailError,v=a=>k(a)?"":a===""?s.LoginFormMissingEmailError:s.LoginFormInvalidEmailError,p=a=>{const l=a.target;t.value={...t.value,available:!0,error:"",pending:!0,value:l.value}},_=a=>{const l=a.target,E=v(l.value);l.setCustomValidity(E),t.value={...t.value,error:E}},f=a=>{const l=a.target;t.value={...t.value,error:h(l.validity)}};x(()=>{!i||r.initialized||(t.value={available:!0,error:"",initialized:!0,pending:!1,value:i.email??""})},[i,r]),x(()=>{if(!r.initialized||M.authenticated)return;const a=setTimeout(()=>{if(!k(r.value)||r.value===u.current){t.value={...t.value,pending:!1};return}u.current=r.value,I(r.value).then(l=>{const E=F!==r.value;t.value={...t.value,available:l,pending:E},E&&V(r.value).catch(console.error).finally(()=>{t.value={...t.value,pending:!1}})}).catch(l=>{console.error(l),t.value={...t.value,available:!0,pending:!1}})},O);return()=>{a&&clearTimeout(a)}},[F,r]);const y=r.available?"":m(B,{children:[s.LoginFormEmailExistsAlreadyHaveAccount," ",e("a",{href:"#",onClick:a=>{a.preventDefault(),o==null||o(r.value)},children:s.LoginFormEmailExistsSignInButton})," ",s.LoginFormEmailExistsForFasterCheckout]}),z=a=>{o==null||o(k(a)?a:"")},A=c?{firstName:c.firstName,lastName:c.lastName,email:c.email}:void 0;return e(U,{...g,customerDetails:A,email:r.value,error:r.error,hint:y,loading:r.initialized===!1,onEmailBlur:_,onEmailChange:p,onEmailInvalid:f,onSignInClick:z,onSignOutClick:n})};C.displayName="LoginFormContainer";const fe=j(C);export{fe as LoginForm,fe as default};
